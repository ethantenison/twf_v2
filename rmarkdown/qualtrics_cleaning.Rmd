---
title: "qualtrics_cleaning"
author: "Ethan Tenison"
date: "`r format(Sys.Date(), '%B %d, %Y') `"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Qualtrics data cleaning 

```{r libraries}

library(tidyverse)
library(qualtRics)
library(conflicted)
library(janitor)
library(ggmap)

conflict_prefer("filter", "dplyr")

```

### Data pull 

```{r pull}

# Connecting to the Qualtrics API
qualtrics_api_credentials(
api_key = Sys.getenv("qualtrics_key"), 
base_url = "ca1.qualtrics.com"
)

#Pulling list of surveys
surveys <- all_surveys() 
#Finding the row index for organization and student surveys
survey_number <- which(surveys$name=="PT 2050 ENGOs in Texas - Final", arr.ind=TRUE)
#Fetching the Survey Contents 
df_raw <- fetch_survey(surveyID = surveys$id[survey_number], force_request = TRUE)

```

### Trimming data 

```{r trimming}


df <- df_raw |> 
  clean_names() |> 
  filter(finished != FALSE) |> #close to 100 didn't finish 
  select(-c(start_date:user_language)) |> 
  filter(q1_2 != "lll")

```


### Geomapping

```{r simple_map, echo=FALSE}


df2 <- df |>
  filter(q7_21 == "Yes",!is.na(q7_18)) |>
  mutate(lon = NA, 
         lat = NA,
         q7_18 = case_when( #fixing addresses 
           q7_18 == "3710 Cedar St., Suite #230, Austin, Texas, 78705" ~
             "3710 Cedar St, Austin, TX 78705",
           q7_18 == "2186 Jackson Keller Road #533, San Antonio Tx 78213" ~
             "2186 Jackson Keller Road, San Antonio, TX 78213",
           q7_18 == "PO Box 140650" ~
             "PO Box 140650, Dallas, TX 75214",
           q7_18 == "2921 East 17th Street, Building D, Ste #1, Austin Texas 78702" ~
             "2921 East 17th Street, Austin, TX 78702",
           q7_18 == "801 S Fillmore St. #700  Amarillo/Texas/79101" ~
             "801 S Fillmore, Amarillo, TX 79101",
           q7_18 == "P.O. Box 685261" ~
             "Po Box 685261, Austin, TX 78768",
           TRUE ~ q7_18
         ))

geocodes <- geocode(as.character(df2$q7_18))
df2[,204:205] <- geocodes

```


```{r leaflet}
library(leaflet)

m <- leaflet(df2) |> 
  addTiles() |> 
  addMarkers(lng = df2$lon, lat = df2$lat)
m

```


# Data minus network 

```{r data_nonetwork}

df3 <- df2 |> 
  select(-c(starts_with("q3"),#removing network questions
            -c(starts_with("q6")),
            -c(q1_3:q1_6, q8_5))) |>  #mostly blank data 
  mutate(q2_3_4 = replace_na(q2_3_4,""),#collapsing the secondary obj
         q2_3_5 = replace_na(q2_3_5,""),
         q2_3_6 = replace_na(q2_3_6,""),
         q2_3_7 = replace_na(q2_3_7,""),
         q2_3_8 = replace_na(q2_3_8,""),
         q2_3 = paste0(q2_3_4,",", q2_3_5,
                       ",", q2_3_6,",", q2_3_7,",", q2_3_8),
         q2_3 = gsub("^,+|,+$", "",q2_3 ),
         q2_3 = gsub(",,", ", ",q2_3 ),
         q2_3 = gsub(",", ", ",q2_3 ))



```

